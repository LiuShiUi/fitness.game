<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥èº«å†’éšªè­š Fitness Saga - æ‰‹éŠç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40jB90W6W3g0JAhqA5o7qL1dO2b5F+YdCjI/gYpG8hGgYg0F9d+Q7P2sM3d9sK6B1c4pG1d3u7fA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Cinzel:wght@700&display=swap');

        :root {
            --bg-dark: #121212;
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #e94560;
            --str-color: #ffc107; /* åŠ›é‡é»ƒ */
            --end-color: #03a9f4; /* è€åŠ›è— */
            --text-light: #e0e0e0;
            --text-dark: #333;
            --border-color: #537895;
        }

        /* 1. Mobile First: Single Column Layout */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 0; /* ç§»é™¤ body é‚Šè· */
            min-height: 100vh;
            padding-bottom: 60px; /* åº•éƒ¨å°èˆªåˆ—ç©ºé–“ */
        }

        .game-world {
            width: 100%;
            max-width: 1200px;
            display: block; /* é è¨­å †ç–Š */
            gap: 0;
            padding: 10px 10px 0 10px; /* å…§é‚Šè· */
        }

        /* --- å·¦å´è§’è‰²é¢æ¿ (æ‰‹æ©Ÿä¸Šç‚ºé ‚éƒ¨å€å¡Š) --- */
        .character-panel {
            background-color: var(--primary);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative; /* æ‰‹æ©Ÿä¸Šä¸ç²˜æ»¯ */
            margin-bottom: 10px;
            transition: border-color 0.5s ease;
        }

        .avatar-container {
            background-color: var(--secondary);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }
        #avatar-image {
            width: 100%;
            height: 150px; /* æ‰‹æ©Ÿä¸Šç•¥å° */
            background-color: #000;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            font-family: 'Cinzel', serif;
            transition: all 0.5s ease;
        }
        #player-name {
            font-family: 'Cinzel', serif;
            font-size: 1.5em;
            color: var(--accent);
            margin-top: 10px;
        }
        
        /* New: Gold Display */
        .gold-display {
            background-color: var(--str-color);
            color: var(--text-dark);
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: bold;
            font-family: 'Cinzel', serif;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .gold-display span {
            font-size: 1.2em;
        }


        .xp-bar {
            width: 100%; height: 20px; background-color: var(--secondary); border-radius: 10px; overflow: hidden; border: 1px solid var(--border-color);
        }
        .xp-bar > div {
            height: 100%; transition: width 0.5s ease; text-align: right; padding-right: 5px; font-size: 0.8em; font-weight: bold; color: var(--text-dark);
            display: flex; align-items: center; justify-content: flex-end;
        }
        #str-xp-bar { background: linear-gradient(90deg, #ff8f00, var(--str-color)); }
        #end-xp-bar { background: linear-gradient(90deg, #0077c2, var(--end-color)); }

        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        .stat-box {
            background-color: var(--secondary); padding: 8px; border-radius: 5px; text-align: center;
        }
        .stat-box .label { font-size: 0.8em; color: #aaa; }
        .stat-box .value { font-size: 1.2em; font-weight: bold; }

        /* --- å³å´ä¸»å…§å®¹å€ (æ‰‹æ©Ÿä¸Šç‚ºåº•éƒ¨å€å¡Š) --- */
        .main-content {
            background-color: var(--primary);
            border: 2px solid var(--border-color);
            border-radius: 15px 15px 0 0; /* æ‰‹æ©Ÿåº•éƒ¨åœ“è§’ */
            padding: 20px 20px 10px 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .tabs { display: none; } /* éš±è—é ‚éƒ¨å°èˆªï¼Œæ”¹ç”¨åº•éƒ¨å°èˆª */
        .tab-button {
            padding: 10px 20px; cursor: pointer; background: none; border: none; color: var(--text-light); font-size: 1em; font-weight: bold;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover { color: var(--accent); }
        .tab-button.active { color: var(--accent); border-bottom-color: var(--accent); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* æ´»å‹•å¡ç‰‡ */
        .activity-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 20px; /* æ‰‹æ©Ÿä¸Šå¡ç‰‡å¯ä»¥å°ä¸€é» */
        }
        .activity-card {
            background-color: var(--secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px; /* ç•¥æ¸›å…§é‚Šè· */
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        /* Inbody & æˆå°± */
        .form-grid, .achievement-grid {
            display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; /* æ‰‹æ©Ÿä¸Šå–®æ¬„é¡¯ç¤º */
        }

        /* New: Tavern Styles */
        #tavern-chat-box {
            background-color: var(--secondary);
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: scroll;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }
        .chat-message {
            margin-bottom: 10px;
            text-align: left;
        }
        .chat-message .meta {
            font-size: 0.8em;
            color: var(--accent);
            font-weight: bold;
            display: block;
        }
        .chat-message p {
            margin: 3px 0 0 0;
            padding: 8px 12px;
            background-color: #333;
            border-radius: 15px;
            display: inline-block;
            max-width: 90%;
        }
        #chat-input-container {
            display: flex;
            gap: 10px;
        }
        #chat-input-container input {
            flex-grow: 1;
            background-color: var(--secondary); border: 1px solid var(--border-color); color: var(--text-light); padding: 8px; border-radius: 5px;
        }


        /* New: Bottom Navigation Bar (Mobile UI) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: var(--secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-size: 0.7em;
            cursor: pointer;
            width: 20%;
            height: 100%;
            transition: color 0.2s;
            font-weight: bold;
        }
        .nav-item.active {
            color: var(--accent);
        }
        .nav-item i {
            font-size: 1.5em;
            margin-bottom: 3px;
        }


        /* 2. Desktop Layout (Two Columns) */
        @media (min-width: 768px) {
            body {
                padding: 20px;
                padding-bottom: 0; /* æ¡Œé¢ç§»é™¤åº•éƒ¨å°èˆªç©ºé–“ */
            }
            .game-world {
                display: grid;
                grid-template-columns: 300px 1fr;
                gap: 20px;
                padding: 0;
            }
            .character-panel {
                position: sticky; /* Sticky on desktop */
                top: 20px;
                margin-bottom: 0;
            }
            .main-content {
                border-radius: 15px;
                padding: 20px;
            }
            .tabs { display: flex; } /* æ¡Œé¢é¡¯ç¤ºé ‚éƒ¨å°èˆª */
            .bottom-nav { display: none; } /* æ¡Œé¢éš±è—åº•éƒ¨å°èˆª */
            .form-grid { grid-template-columns: repeat(2, 1fr); }
            #avatar-image { height: 200px; } /* æ¡Œé¢é ­åƒæ”¾å¤§ */
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

</head>
<body>

    <div class="game-world">
        <aside class="character-panel">
            <div class="gold-display">
                <i class="fas fa-coins"></i> å‹•åŠ›å¹£: <span id="gold-val">0</span>
            </div>

            <div class="avatar-container">
                <div id="avatar-image">ğŸ›¡ï¸</div>
                <h3 id="player-name">å†’éšªå®¶</h3>
            </div>
            <div>
                <label>åŠ›é‡ç­‰ç´š (STR Lvl.<span id="str-level-val">1</span>)</label>
                <div class="xp-bar"><div id="str-xp-bar"></div></div>
            </div>
            <div>
                <label>è€åŠ›ç­‰ç´š (END Lvl.<span id="end-level-val">1</span>)</label>
                <div class="xp-bar"><div id="end-xp-bar"></div></div>
            </div>
            <div class="stats-grid">
                <div class="stat-box"><div class="label">ç¸½ç­‰ç´š</div><div class="value" id="level-val">1</div></div>
                <div class="stat-box"><div class="label">è·¯ç·š</div><div class="value" id="path-val">-</div></div>
                <div class="stat-box"><div class="label">è‚Œé‡(kg)</div><div class="value" id="muscle-val">-</div></div>
                <div class="stat-box"><div class="label">é«”è„‚(%)</div><div class="value" id="fat-val">-</div></div>
            </div>
        </aside>

        <main class="main-content">
            <div class="tabs">
                <button class="tab-button active" onclick="navigate('training', this)">ğŸ‹ï¸ è¨“ç·´å ´</button>
                <button class="tab-button" onclick="navigate('inbody', this)">ğŸ§¬ æ•¸æ“šç´€éŒ„</button>
                <button class="tab-button" onclick="navigate('avatar', this)">ğŸ›ï¸ è¡£æ«¥/è§’è‰²</button>
                <button class="tab-button" onclick="navigate('achievements', this)">ğŸ† æˆå°±æ®¿å ‚</button>
                <button class="tab-button" onclick="navigate('tavern', this)">ğŸ» è§£æ†‚é…’é¤¨</button>
            </div>

            <div id="training" class="tab-content active">
                <h3>ä»Šæ—¥ä»»å‹™æ¸…å–® (æ¯æ—¥åˆ·æ–°ï¼šCD7 ä¸ç¢ºå®šæ€§)</h3>
                <h4 style="margin-top: 15px;">å¢è‚Œè·¯ç·šæ´»å‹• (STR å°å‘)</h4>
                <div id="muscle-activities" class="activity-grid"></div>
                <h4 style="margin-top: 20px;">æ¸›è„‚è·¯ç·šæ´»å‹• (END å°å‘)</h4>
                <div id="fatloss-activities" class="activity-grid"></div>
            </div>

            <div id="inbody" class="tab-content">
                <h3>æ›´æ–°ä½ çš„ inBody æ•¸æ“š (CD2 ç™¼å±•èˆ‡æˆå°±)</h3>
                <p>å®šæœŸæ›´æ–°æ•¸æ“šæ˜¯éŠæˆ²ä¸­ç²å¾—å¤§é‡ XP å’Œ **å‹•åŠ›å¹£** çš„é‡è¦æ–¹å¼ï¼Œåæ˜ äº†ä½ åœ¨ç¾å¯¦ä¸­çš„åŠªåŠ›æˆæœã€‚</p>
                <div class="form-grid">
                    <div class="form-group"><label for="inbody-muscle">éª¨éª¼è‚Œé‡ (kg)</label><input type="number" id="inbody-muscle" step="0.1"></div>
                    <div class="form-group"><label for="inbody-fat">é«”è„‚ç‡ (%)</label><input type="number" id="inbody-fat" step="0.1"></div>
                    <div class="form-group"><label for="inbody-visceral">å…§è‡Ÿè„‚è‚ªç­‰ç´š</label><input type="number" id="inbody-visceral" step="1"></div>
                    <div class="form-group"><label for="inbody-weight">é«”é‡ (kg)</label><input type="number" id="inbody-weight" step="0.1"></div>
                </div>
                <button class="submit-btn" onclick="updateInBody()">æäº¤æ•¸æ“šä¸¦çµç®—çå‹µ</button>
            </div>
            
            <div id="avatar" class="tab-content">
                <h3>è§’è‰²å¤–è§€èˆ‡å®¢è£½åŒ– (CD3 å‰µé€ åŠ›èˆ‡å›é¥‹)</h3>
                <p>è¨­å®šæ‚¨çš„åŸºæœ¬è³‡æ–™ï¼Œæ‚¨çš„ InBody æ•¸æ“šå°‡å½±éŸ¿è§’è‰²çš„è™›æ“¬é«”æ…‹ã€‚</p>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="char-gender">æ€§åˆ¥</label>
                        <select id="char-gender" style="padding: 8px; border-radius: 5px; background-color: var(--secondary); border: 1px solid var(--border-color); color: var(--text-light);" onchange="updateCharacterSettings()">
                            <option value="male">ç”·æ€§ â™‚</option>
                            <option value="female">å¥³æ€§ â™€</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="char-height">èº«é«˜ (cm)</label><input type="number" id="char-height" step="1" min="100" max="250"></div>
                </div>
                <button class="submit-btn" onclick="updateCharacterSettings()">ç¢ºèªè§’è‰²è¨­å®šè®Šæ›´</button>

                <div style="margin-top: 30px;">
                    <h4>è¡£æ«¥ (é‡‘å¹£å•†åº—ï¼šCD6 ç¨€ç¼ºæ€§)</h4>
                    <p>æ¶ˆè€— <span style="color: var(--str-color); font-weight: bold;">å‹•åŠ›å¹£</span> è³¼è²·æ–°çš„æœè£èˆ‡é€ å‹ï¼</p>
                    <div id="store-items" class="activity-grid">
                        <div class="activity-card" onclick="buyItem('hat')"><h4>ğŸ§™ é­”æ³•å¸½</h4><div class="xp-reward">ğŸ’° 500</div></div>
                        <div class="activity-card" onclick="buyItem('shirt')"><h4>ğŸ‘• æˆ°å£«Tæ¤</h4><div class="xp-reward">ğŸ’° 800</div></div>
                        <div class="activity-card" onclick="buyItem('shoes')"><h4>ğŸ‘Ÿ ç–¾é¢¨è·‘é‹</h4><div class="xp-reward">ğŸ’° 1200</div></div>
                    </div>
                </div>
            </div>

            <div id="achievements" class="tab-content">
                <h3>æ¦®è­½çå‹µ (CD4 æ‰€æœ‰æ¬Šèˆ‡ä½”æœ‰æ¬²)</h3>
                <p>è§£é–é€™äº›æˆå°±ï¼Œè­‰æ˜ä½ çš„åŠªåŠ›èˆ‡å …æŒã€‚</p>
                <div id="achievement-list" class="achievement-grid"></div>
            </div>

            <div id="tavern" class="tab-content">
                <h3>è§£æ†‚é…’é¤¨ (åŒ¿åç¤¾ç¾¤ï¼šCD5 åŒç†å¿ƒ)</h3>
                <p>åœ¨é€™è£¡ï¼Œæ‚¨å¯ä»¥åŒ¿åç™¼å¸ƒæ‚¨çš„å¥èº«å¿ƒå¾—ã€å›°æ“¾æˆ–å°‹æ±‚é¼“å‹µã€‚æ‰€æœ‰ä½¿ç”¨è€…åç¨±çš†ç‚ºç³»çµ±éš¨æ©Ÿåˆ†é…ã€‚</p>
                <div id="tavern-chat-box">
                    <div class="chat-message"><span class="meta">#34 ç˜¦ä¸ä¸‹ä¾†çš„å²èŠå§†</span><p>æˆ‘å·²ç¶“é€£çºŒå…©é€±é«”é‡æ²’å‹•äº†...å¿«æ’ä¸ä¸‹å»äº†ï¼Œæœ‰äººèƒ½çµ¦æˆ‘ä¸€äº›çªç ´å¹³å°æœŸçš„å»ºè­°å—ï¼Ÿ</p></div>
                    <div class="chat-message"><span class="meta">#12 åŠ›é‡ä¹‹ç‹</span><p>åˆ¥æ”¾æ£„ï¼å¤šå˜—è©¦ä¸åŒçš„è¨“ç·´å¼·åº¦æˆ–æ›å€‹æœ‰æ°§æ–¹å¼ï¼ğŸ’ª å…§è‡Ÿè„‚è‚ªä¸‹é™ä¸€éšçš„æˆå°±è¶…è®šï¼</p></div>
                </div>
                <div id="chat-input-container">
                    <input type="text" id="tavern-input" placeholder="åŒ¿åç™¼å¸ƒæ‚¨çš„è¨Šæ¯..." maxlength="100">
                    <button class="submit-btn" style="padding: 8px 15px; width: auto; margin-top: 0;" onclick="postAnonymousMessage()">ç™¼å¸ƒ</button>
                </div>
            </div>

        </main>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="navigate('training', this)"><i class="fas fa-dumbbell"></i> è¨“ç·´å ´</div>
        <div class="nav-item" onclick="navigate('avatar', this)"><i class="fas fa-user-circle"></i> è¡£æ«¥</div>
        <div class="nav-item" onclick="navigate('achievements', this)"><i class="fas fa-trophy"></i> æˆå°±</div>
        <div class="nav-item" onclick="navigate('tavern', this)"><i class="fas fa-beer"></i> é…’é¤¨</div>
    </div>


    <div id="path-selection-overlay" class="overlay">
        <div class="modal">
            <h2>é¸æ“‡ä½ çš„å†’éšªè·¯ç·šï¼ˆé©…å‹•åŠ›ï¼šé‡å¤§ä½¿å‘½ CD1ï¼‰</h2>
            <p>è·¯ç·šå°‡æ±ºå®šä½ çš„ä¸»è¦ç¶“é©—å€¼ä¾†æºèˆ‡ç›®æ¨™ã€‚</p>
            <div class="path-buttons">
                <button id="muscle-path-btn" class="path-btn" onclick="choosePath('muscle')">ğŸ’ª å¢è‚Œè·¯ç·š - æˆç‚ºåŠ›é‡ä¹‹ç‹</button>
                <button id="fatloss-path-btn" class="path-btn" onclick="choosePath('fatloss')">ğŸ”¥ æ¸›è„‚è·¯ç·š - æˆç‚ºè€åŠ›ä¹‹ç¥</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <div id="auth-overlay" class="overlay" style="display: flex; z-index: 200;">
        <div class="modal">
            <h2>ç™»å…¥å¥èº«å†’éšªè­š</h2>
            <p>ç™»å…¥ä»¥åŒæ­¥æ‚¨çš„é›²ç«¯é€²åº¦ï¼ï¼ˆé©…å‹•åŠ›ï¼šæå¤±é¿å… CD8ï¼‰</p>
            <div class="path-buttons">
                <button id="google-login-btn" class="path-btn" onclick="signInWithGoogle()" style="background-color: #4285F4; color: white; border: 2px solid #8ab4f8;">ğŸš€ Google ç™»å…¥</button>
                
                <button id="guest-login-btn" class="path-btn" onclick="guestSignIn()" style="background-color: var(--secondary); color: var(--text-light); border: 2px solid #aaa; margin-top: 10px;">ğŸ‘Ÿ éŠå®¢æ¨¡å¼ (ç„¡éœ€ç™»å…¥)</button>
                </div>
            <div style="margin-top: 20px; display: flex; flex-direction: column; align-items: center;">
                <input type="email" id="email-input" placeholder="é›»å­éƒµä»¶" style="width: 80%; padding: 10px; margin-bottom: 10px; background-color: var(--secondary); border: 1px solid var(--border-color); color: var(--text-light); border-radius: 5px;">
                <input type="password" id="password-input" placeholder="å¯†ç¢¼" style="width: 80%; padding: 10px; margin-bottom: 10px; background-color: var(--secondary); border: 1px solid var(--border-color); color: var(--text-light); border-radius: 5px;">
                <button id="email-login-btn" class="submit-btn" onclick="signInWithEmail()" style="width: 85%; margin-top: 0;">ç™»å…¥æˆ–è¨»å†Š</button>
            </div>
        </div>
    </div>


    <script>
    // --- ğŸ”¥ 3. Firebase åˆå§‹åŒ–èˆ‡é©—è­‰æ ¸å¿ƒé‚è¼¯ (ä½¿ç”¨ v9.x.x compat) ---
    
    // Your web app's Firebase configuration
    // âš ï¸ å‹™å¿…å°‡ä»¥ä¸‹é…ç½®æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„ Firebase Project é…ç½®
    const firebaseConfig = {
        apiKey: "AIzaSyDz_F9aS9M78QJ9_aouz_7AvfWvs-FrRcM", // æ›¿æ›ç‚ºä½ çš„ API Key
        authDomain: "fitness-saga-web.firebaseapp.com",
        projectId: "fitness-saga-web",
        storageBucket: "fitness-saga-web.firebasestorage.app",
        messagingSenderId: "889222535170",
        appId: "1:889222535170:web:79ed27698667d2e0f02f1b",
        measurementId: "G-7TTJV96B8T"
    };

    // åˆå§‹åŒ– Firebase App
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    db.settings({ timestampsInSnapshots: true }); // è¨­ç½® Firestore
    let currentUser = null; // ç”¨ä¾†å„²å­˜ç•¶å‰ç™»å…¥çš„ä½¿ç”¨è€…

    // --- æ–°å¢éŠå®¢æ¨¡å¼çš„å¸¸æ•¸èˆ‡å‡½å¼ ---
    const GUEST_ID_KEY = 'fitnessSagaGuestId';
    const GUEST_STATE_KEY = 'fitnessSagaGuestState';

    function generateGuestId() {
        return 'guest_' + Math.random().toString(36).substring(2, 9) + Date.now().toString().substring(9);
    }
    
    // éŠå®¢ç™»å…¥å‡½å¼
    function guestSignIn() {
        let guestId = localStorage.getItem(GUEST_ID_KEY);
        if (!guestId) {
            guestId = generateGuestId();
            localStorage.setItem(GUEST_ID_KEY, guestId);
        }
        
        // å»ºç«‹ä¸€å€‹æ¨¡æ“¬çš„ currentUser ç‰©ä»¶ï¼ŒåŒ…å« isGuest æ¨™è¨˜
        currentUser = {
            uid: guestId,
            isGuest: true,
            displayName: 'éŠå®¢å†’éšªè€…',
            email: 'guest@local.host'
        };

        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('player-name').textContent = currentUser.displayName;
        
        loadGameFromLocalStorage(); // è¼‰å…¥éŠå®¢çš„æœ¬åœ°éŠæˆ²è³‡æ–™
        showToast('æ­¡è¿ä¾†åˆ°éŠå®¢æ¨¡å¼ï¼é€²åº¦å°‡å„²å­˜åœ¨æœ¬æ©Ÿã€‚', 'info');
    }

    // ç›£è½ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹çš„è®ŠåŒ– (å·²ä¿®æ”¹ï¼ŒåŒ…å«éŠå®¢æ¨¡å¼é‚è¼¯)
    auth.onAuthStateChanged(user => {
        if (user) {
            // --- æƒ…æ³ A: æ­£å¼ç”¨æˆ¶å·²ç™»å…¥ (FIREBASE) ---
            currentUser = user;
            document.getElementById('auth-overlay').style.display = 'none'; // éš±è—ç™»å…¥ç•«é¢
            document.getElementById('player-name').textContent = user.displayName || user.email.split('@')[0] || 'å†’éšªå®¶';
            loadGameFromFirestore(); // å¾ Firestore è®€å–é›²ç«¯éŠæˆ²è³‡æ–™
        } else {
            // --- æƒ…æ³ B: ç”¨æˆ¶æœªç™»å…¥ (æª¢æŸ¥æ˜¯å¦ç‚ºéŠå®¢) ---
            const guestId = localStorage.getItem(GUEST_ID_KEY);
            const guestState = localStorage.getItem(GUEST_STATE_KEY);
            
            if (guestId && guestState) {
                // æ˜¯éŠå®¢ï¼Œè‡ªå‹•é€²å…¥éŠå®¢æ¨¡å¼
                currentUser = { uid: guestId, isGuest: true, displayName: 'éŠå®¢å†’éšªå®¶', email: 'guest@local.host' };
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('player-name').textContent = currentUser.displayName;
                loadGameFromLocalStorage();
            } else {
                // æƒ…æ³ C: æ—¢ä¸æ˜¯æ­£å¼ç”¨æˆ¶ä¹Ÿä¸æ˜¯éŠå®¢ (æˆ–éŠå®¢è³‡æ–™å·²æ¸…é™¤)
                currentUser = null;
                document.getElementById('auth-overlay').style.display = 'flex'; // é¡¯ç¤ºç™»å…¥ç•«é¢
                resetGameState();
                updateAllUI();
            }
        }
    });

    // Google ç™»å…¥å‡½å¼
    function signInWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(error => {
            console.error("Google ç™»å…¥å¤±æ•—:", error);
            showToast(`Google ç™»å…¥å¤±æ•—: ${error.message}`);
        });
    }

    // Email/å¯†ç¢¼ ç™»å…¥æˆ–è¨»å†Šå‡½å¼
    function signInWithEmail() {
        const email = document.getElementById('email-input').value;
        const password = document.getElementById('password-input').value;
        if (!email || !password) {
            showToast("è«‹è¼¸å…¥ Email å’Œå¯†ç¢¼");
            return;
        }
        auth.signInWithEmailAndPassword(email, password)
            .catch(error => {
                if (error.code === 'auth/user-not-found') {
                    // å¦‚æœå¸³è™Ÿä¸å­˜åœ¨ï¼Œå°±è‡ªå‹•è¨»å†Šä¸€å€‹æ–°çš„
                    showToast("å¸³è™Ÿä¸å­˜åœ¨ï¼Œç‚ºæ‚¨è‡ªå‹•è¨»å†Š...");
                    auth.createUserWithEmailAndPassword(email, password)
                        .catch(err => {
                            console.error("è¨»å†Šå¤±æ•—:", err);
                            showToast(`è¨»å†Šå¤±æ•—: ${err.message}`);
                        });
                } else {
                    console.error("ç™»å…¥å¤±æ•—:", error);
                    showToast(`ç™»å…¥å¤±æ•—: ${error.message}`);
                }
            });
    }


    // --- éŠæˆ²è³‡æ–™åº« (Game Data) ---
    const activities = {
        m01: { name: 'é‡è¨“ï¼ˆè‡ªç”±é‡é‡ï¼‰', str: 50, end: 10 }, 
        m02: { name: 'åœ°é›·ç®¡æ¨', str: 60, end: 5 }, 
        m03: { name: 'å¢è‚Œé£²é£Ÿé”æ¨™', str: 50, end: 0 }, 
        m04: { name: 'å‰µé€ æ€§å¼µåŠ›è¨“ç·´', str: 70, end: 15 }, 
        m05: { name: 'æ¼¸é€²å¼è¶…è² è· (PR)', str: 150, end: 20 }, 
        m06: { name: 'ç¡çœ é”æ¨™ (8å°æ™‚)', str: 20, end: 20 }, 
        m07: { name: 'ä¹³æ¸…è£œçµ¦', str: 15, end: 5 }, 
        m08: { name: 'è‚Œé…¸è£œçµ¦', str: 25, end: 5 }, 
        m09: { name: 'çµ„é–“ä¼‘æ¯2â€“3åˆ†é˜', str: 10, end: 0 }, 
        m10: { name: 'é”æˆé‡é‡ç´šæˆå°±', str: 200, end: 0 }, 
        m11: { name: 'è¨˜éŒ„è‚Œè‚‰åœåº¦', str: 15, end: 0 },
        f01: { name: 'æœ‰æ°§ï¼ˆè·‘æ­¥/ç™»éšï¼‰', str: 5, end: 50 }, 
        f02: { name: 'é«˜å¼·åº¦é–“æ­‡ HIIT', str: 20, end: 120 }, 
        f03: { name: 'ç†±é‡èµ¤å­—é£²é£Ÿ', str: 0, end: 60 }, 
        f04: { name: '168 æ–·é£Ÿé”æ¨™', str: 0, end: 40 }, 
        f05: { name: 'æ­¥è¡Œ >8000 æ­¥', str: 5, end: 45 }, 
        f06: { name: 'å°‘ç³–é£²é£Ÿ', str: 0, end: 30 }, 
        f07: { name: 'å°‘æ²¹çƒ¹èª¿', str: 0, end: 25 }, 
        f08: { name: 'å¿ƒç‡ zone2 30åˆ†é˜', str: 5, end: 70 }, 
        f09: { name: 'æ™šé¤ææ—©åƒ', str: 0, end: 20 }, 
        f10: { name: 'ç³–æ”å– <25g', str: 0, end: 35 },
    };

    const achievements = {
        ach_newbie: { name: 'æ–°æ‰‹å†’éšªè€…', desc: 'å®Œæˆé¦–æ¬¡è¨“ç·´ç´€éŒ„', unlocked: false, icon: 'ğŸ”°' }, 
        ach_7day: { name: 'æŒçºŒä¹‹åŠ›', desc: 'ç´¯è¨ˆç´€éŒ„ 7 æ¬¡', unlocked: false, icon: 'ğŸ—“ï¸' }, 
        ach_sleep: { name: 'å°ˆæ³¨ä¹‹é­‚', desc: 'ç¡çœ é”æ¨™ 5 æ¬¡', unlocked: false, icon: 'ğŸŒ™' }, 
        ach_inbody: { name: 'é«”æ…‹é›é€ è€…', desc: 'é¦–æ¬¡ inBody æ•¸æ“šæ”¹å–„', unlocked: false, icon: 'ğŸ§¬' },
        ach_ironwill: { name: 'éµä¹‹æ„å¿—', desc: 'é‡è¨“ç´¯è¨ˆ 14 æ¬¡', unlocked: false, icon: 'ğŸ‹ï¸' }, 
        ach_muscledev: { name: 'è‚Œè‚‰é–‹ç™¼è€…', desc: 'è‚Œé‡ç¸½å…±ä¸Šå‡ 0.3 kg', unlocked: false, icon: 'ğŸ’ª' }, 
        ach_pr: { name: 'è¶…è² è·å‹‡è€…', desc: 'çªç ´ PR 1 æ¬¡', unlocked: false, icon: 'ğŸ’¥' },
        ach_shadowstep: { name: 'å½±ä¹‹æ­¥è€…', desc: 'æ­¥è¡Œ >8000 æ­¥ (å–®æ—¥)', unlocked: false, icon: 'ğŸ‘Ÿ' }, 
        ach_fatburner: { name: 'ç„šè„‚èˆè€…', desc: 'HIIT ç´¯è¨ˆ 5 æ¬¡', unlocked: false, icon: 'ğŸ”¥' }, 
        ach_visceral: { name: 'å…§è‡Ÿç ´å£è€…', desc: 'å…§è‡Ÿè„‚è‚ªä¸‹é™ä¸€éš', unlocked: false, icon: 'â¤ï¸â€ğŸ©¹' },
    };

    // --- éŠæˆ²ç‹€æ…‹ (Game State) ---
    let gameState = {};
    
    // å‡½å¼ï¼šé‡ç½®ç‚ºåˆå§‹éŠæˆ²ç‹€æ…‹
    function resetGameState() {
        // é‡ç½®æ™‚ç¢ºä¿æˆå°±çš„æè¿°å’Œåœ–æ¨™æ˜¯æœ€æ–°çš„ï¼Œä½†é–å®šç‹€æ…‹ç‚ºåˆå§‹
        const initialAchievements = {};
        for (const id in achievements) {
            initialAchievements[id] = { ...achievements[id], unlocked: false };
        }

        gameState = {
            path: null, 
            level: 1,
            str: { xp: 0, level: 1 },
            end: { xp: 0, level: 1 },
            gold: 0, // æ–°å¢é‡‘å¹£ç³»çµ±
            gender: 'male', // æ–°å¢æ€§åˆ¥
            height: 170, // æ–°å¢èº«é«˜
            inbody: { muscle: null, fat: null, visceral: null, weight: null },
            log: { total_records: 0, sleep_records: 0, pr_records: 0, workout_records: 0, hiit_records: 0 },
            achievements: initialAchievements,
            inventory: [] // æ–°å¢å·²è³¼è²·ç‰©å“
        };
    }
    resetGameState(); // é¦–æ¬¡è¼‰å…¥æ™‚å…ˆåˆå§‹åŒ–ä¸€æ¬¡

    // --- æ ¸å¿ƒéŠæˆ²é‚è¼¯ (Core Game Logic) ---
    // ç­‰ç´šæ‰€éœ€ç¶“é©—å€¼å…¬å¼ (æŒ‡æ•¸æˆé•·ï¼Œæ›´ç¬¦åˆé•·æœŸéŠæˆ²åŒ–è¨­è¨ˆ)
    const xpForLevel = (level) => Math.floor(100 * Math.pow(1.5, level - 1)); 

    // æª¢æŸ¥éŠå®¢æ¨¡å¼ï¼Œä¸¦æä¾›å‡ç´šæé†’ (CD8)
    function checkGuestMode(actionName) {
        if (currentUser && currentUser.isGuest) {
            showToast(`âš ï¸ æ‚¨ç›®å‰æ˜¯éŠå®¢æ¨¡å¼ã€‚è‹¥è¦æ°¸ä¹…ä¿å­˜ã€Œ${actionName}ã€å’Œæˆå°±ï¼Œè«‹è¨»å†Šæ­£å¼å¸³è™Ÿï¼`, 'error');
            return true;
        }
        return false;
    }

    function choosePath(path) {
        if (!currentUser) {
            showToast('è«‹å…ˆç™»å…¥æ‰èƒ½é¸æ“‡è·¯ç·šï¼', 'error');
            return;
        }
        checkGuestMode('è·¯ç·šé¸æ“‡');

        gameState.path = path;
        document.getElementById('path-selection-overlay').style.display = 'none';
        showToast(`ä½ å·²é¸æ“‡ ${path === 'muscle' ? 'ğŸ’ª å¢è‚Œ' : 'ğŸ”¥ æ¸›è„‚'} è·¯ç·šï¼`);
        updateAllUI();
        saveGame();
    }
    
    // æ–°å¢ï¼šè§’è‰²è¨­å®šè®Šæ›´ï¼ˆåŒ…å«æ€§åˆ¥å’Œèº«é«˜ï¼‰
    function updateCharacterSettings() {
        if (!currentUser) {
            showToast('è«‹å…ˆç™»å…¥æ‰èƒ½è¨­å®šï¼', 'error');
            return;
        }
        
        const newGender = document.getElementById('char-gender').value;
        const newHeight = parseFloat(document.getElementById('char-height').value);
        
        if (isNaN(newHeight) || newHeight < 100 || newHeight > 250) {
            showToast('è«‹è¼¸å…¥æœ‰æ•ˆèº«é«˜ (100-250 cm)ï¼', 'error');
            return;
        }

        gameState.gender = newGender;
        gameState.height = newHeight;
        
        showToast('è§’è‰²è¨­å®šå·²æ›´æ–°ï¼', 'info');
        updateAllUI();
        saveGame();
    }

    function logActivity(activityId) {
        if (!currentUser) {
            showToast('è«‹å…ˆç™»å…¥æ‰èƒ½ç´€éŒ„æ´»å‹•ï¼', 'error');
            return;
        }
        if (!gameState.path) {
            document.getElementById('path-selection-overlay').style.display = 'flex';
            showToast('è«‹å…ˆé¸æ“‡ä½ çš„å†’éšªè·¯ç·šï¼');
            return;
        }

        checkGuestMode('è¨“ç·´ç´€éŒ„'); // æ–°å¢éŠå®¢æé†’

        const activity = activities[activityId];
        if (!activity) return;

        addXP('str', activity.str);
        addXP('end', activity.end);

        // æ–°å¢é‡‘å¹£çå‹µ (CD2 ç™¼å±•èˆ‡æˆå°±)
        const goldReward = Math.floor(Math.random() * 15) + 5; // 5 to 20 gold
        gameState.gold += goldReward;

        showToast(`å®Œæˆã€Œ${activity.name}ã€! +${activity.str} STR XP, +${activity.end} END XP, ğŸ’° +${goldReward}`);

        gameState.log.total_records++;
        // ç´€éŒ„æ´»å‹•æ¬¡æ•¸ä»¥ä¾›æˆå°±æª¢æŸ¥
        if (activityId === 'm01') gameState.log.workout_records++;
        if (activityId === 'm05') gameState.log.pr_records++;
        if (activityId === 'm06') gameState.log.sleep_records++;
        if (activityId === 'f02') gameState.log.hiit_records++;
        // æª¢æŸ¥å–®æ¬¡é”æ¨™æˆå°± (å¦‚æ­¥è¡Œ)
        if (activityId === 'f05') { checkAchievement('ach_shadowstep', true); }

        checkAllAchievements();
        updateAllUI();
        saveGame();
    }

    function addXP(type, amount) {
        if (amount === 0) return;
        const stat = gameState[type];
        stat.xp += amount;
        
        while (stat.xp >= xpForLevel(stat.level)) {
            stat.xp -= xpForLevel(stat.level);
            stat.level++;
            showToast(`${type.toUpperCase()} ç­‰ç´šæå‡è‡³ ${stat.level}!`, 'level-up');
        }
        // ç¸½ç­‰ç´šç‚ºåŠ›é‡å’Œè€åŠ›ç­‰ç´šçš„å¹³å‡å€¼
        gameState.level = Math.floor((gameState.str.level + gameState.end.level) / 2);
    }

    function updateInBody() {
        if (!currentUser) {
            showToast('è«‹å…ˆç™»å…¥æ‰èƒ½ç´€éŒ„æ•¸æ“šï¼', 'error');
            return;
        }
        
        checkGuestMode('æ•¸æ“šç´€éŒ„'); // æ–°å¢éŠå®¢æé†’

        const newMuscle = parseFloat(document.getElementById('inbody-muscle').value);
        const newFat = parseFloat(document.getElementById('inbody-fat').value);
        const newVisceral = parseInt(document.getElementById('inbody-visceral').value);
        const newWeight = parseFloat(document.getElementById('inbody-weight').value);
        
        if (isNaN(newMuscle) || isNaN(newFat) || isNaN(newVisceral) || isNaN(newWeight)) {
            showToast('è«‹å¡«å¯«æ‰€æœ‰æœ‰æ•ˆçš„ inBody æ•¸æ“šï¼', 'error');
            return;
        }
        
        let strReward = 0;
        let endReward = 0;
        let goldReward = 0; // æ–°å¢é‡‘å¹£è®Šæ•¸
        let improved = false;
        
        const oldMuscle = gameState.inbody.muscle || 0;
        const oldFat = gameState.inbody.fat || Infinity; // åˆå§‹å€¼è¨­ç‚ºç„¡é™å¤§ä»¥ä¾¿æ¯”è¼ƒ
        const oldVisceral = gameState.inbody.visceral || Infinity;
        
        // è¨ˆç®—è‚Œè‚‰æˆé•·çå‹µ (CD2)
        if (newMuscle > oldMuscle) {
            const gain = newMuscle - oldMuscle;
            strReward += gain * 1000;
            goldReward += gain * 100; // è‚Œè‚‰å¢åŠ ç²å¾—é‡‘å¹£
            showToast(`è‚Œè‚‰é‡å¢åŠ  ${gain.toFixed(1)}kgï¼ç²å¾— ${strReward.toFixed(0)} STR XPï¼`);
            improved = true;
            checkAchievement('ach_muscledev', (newMuscle - oldMuscle) >= 0.3);
        }
        
        // è¨ˆç®—é«”è„‚ä¸‹é™çå‹µ (CD2)
        if (newFat < oldFat) {
            const loss = oldFat - newFat;
            endReward += loss * 1500;
            goldReward += loss * 150; // é«”è„‚æ¸›å°‘ç²å¾—é‡‘å¹£
            showToast(`é«”è„‚ç‡ä¸‹é™ ${loss.toFixed(1)}%ï¼ç²å¾— ${endReward.toFixed(0)} END XPï¼`);
            improved = true;
        }
        
        // è¨ˆç®—å…§è‡Ÿè„‚è‚ªä¸‹é™çå‹µ (CD2)
        if (newVisceral < oldVisceral) {
            const loss = oldVisceral - newVisceral;
            endReward += loss * 2000;
            goldReward += loss * 200; // å…§è‡Ÿè„‚è‚ªä¸‹é™ç²å¾—é‡‘å¹£
            showToast(`å…§è‡Ÿè„‚è‚ªä¸‹é™ ${loss} éšï¼ç²å¾— ${loss * 2000} END XPï¼`);
            improved = true;
            checkAchievement('ach_visceral', true);
        }

        if (strReward > 0 || endReward > 0) {
            addXP('str', strReward);
            addXP('end', endReward);
            gameState.gold += goldReward; // ç™¼æ”¾é‡‘å¹£çå‹µ
            showToast(`ğŸ‰ inBody å¤§å¹…é€²æ­¥ï¼ç²å¾—é¡å¤– ğŸ’° ${goldReward.toFixed(0)} å‹•åŠ›å¹£ï¼`, 'achievement');
        } else {
            showToast('æ•¸æ“šå·²è¨˜éŒ„ï¼Œä½†æ²’æœ‰æ¯”ä¸Šæ¬¡é€²æ­¥å–”ï¼ç¹¼çºŒåŠ æ²¹ï¼', 'info');
        }

        // å„²å­˜æ–°æ•¸æ“š
        gameState.inbody = { muscle: newMuscle, fat: newFat, visceral: newVisceral, weight: newWeight };
        
        checkAchievement('ach_inbody', improved);
        updateAllUI();
        saveGame();
    }

    // åŒ¿åèŠå¤©ç™¼å¸ƒï¼ˆCD5 ç¤¾äº¤ï¼‰
    function postAnonymousMessage() {
        const input = document.getElementById('tavern-input');
        const chatBox = document.getElementById('tavern-chat-box');
        const messageText = input.value.trim();
        
        if (!messageText) {
            showToast('è«‹è¼¸å…¥è¨Šæ¯ï¼', 'error');
            return;
        }

        if (messageText.length > 100) {
            showToast('è¨Šæ¯å¤ªé•·äº†ï¼Œæœ€å¤š 100 å­—ï¼', 'error');
            return;
        }

        checkGuestMode('åŒ¿åèŠå¤©ç™¼å¸ƒ');
        
        const randomId = Math.floor(Math.random() * 90) + 10;
        const randomNamePool = ['åŠ›é‡ä¹‹ç‹', 'ç˜¦ä¸ä¸‹ä¾†çš„å²èŠå§†', 'ç²¾éˆå¼“æ‰‹', 'è…¹è‚Œæˆ°ç¥', 'æ·±å¤œè·‘è€…', 'ç†±é‡èµ¤å­—å¤§å¸«', 'è›‹ç™½è³ªçµäºº'];
        const randomName = randomNamePool[Math.floor(Math.random() * randomNamePool.length)];
        
        const newMessage = document.createElement('div');
        newMessage.className = 'chat-message';
        newMessage.innerHTML = `<span class="meta">#${randomId} ${randomName} (æ‚¨)</span><p>${messageText}</p>`;
        
        chatBox.appendChild(newMessage);
        chatBox.scrollTop = chatBox.scrollHeight; // æ²å‹•åˆ°åº•éƒ¨
        input.value = '';

        // æ¨¡æ“¬ç²å¾—ç¤¾äº¤çå‹µ
        gameState.gold += 50;
        showToast('ğŸ» æˆåŠŸç™¼å¸ƒåŒ¿åè¨Šæ¯! ç²å¾— ğŸ’° 50 å‹•åŠ›å¹£ï¼', 'info');
        updateUI();
        saveGame();
    }

    // è³¼ç‰©åŠŸèƒ½ï¼ˆæ¨¡æ“¬ï¼‰
    function buyItem(itemId) {
        const costs = { 'hat': 500, 'shirt': 800, 'shoes': 1200 };
        const cost = costs[itemId];
        const itemName = { 'hat': 'é­”æ³•å¸½', 'shirt': 'æˆ°å£«Tæ¤', 'shoes': 'ç–¾é¢¨è·‘é‹' }[itemId];

        if (gameState.inventory.includes(itemId)) {
            showToast(`æ‚¨å·²ç¶“æ“æœ‰ ${itemName} äº†ï¼`, 'info');
            return;
        }

        if (gameState.gold >= cost) {
            gameState.gold -= cost;
            gameState.inventory.push(itemId);
            showToast(`ğŸ›’ æˆåŠŸè³¼è²· ${itemName}ï¼æ¶ˆè€— ğŸ’° ${cost} å‹•åŠ›å¹£ï¼`, 'achievement');
            updateAllUI();
            saveGame();
        } else {
            showToast(`âš ï¸ å‹•åŠ›å¹£ä¸è¶³ï¼éœ€è¦ ${cost} æ‰èƒ½è³¼è²·ã€‚`, 'error');
        }
    }


    // æª¢æŸ¥ä¸¦è§£é–æˆå°± (CD4)
    function checkAchievement(achId, condition) {
        if (!gameState.achievements[achId].unlocked && condition) {
            const achData = achievements[achId]; 
            
            gameState.achievements[achId].unlocked = true;
            gameState.achievements[achId].name = achData.name;
            gameState.achievements[achId].desc = achData.desc;
            gameState.achievements[achId].icon = achData.icon;
            
            showToast(`ğŸ† æˆå°±è§£é–ï¼š${achData.name}!`, 'achievement');
            updateAchievementsUI();
            saveGame(); 
        }
    }

    function checkAllAchievements() {
        checkAchievement('ach_newbie', gameState.log.total_records >= 1);
        checkAchievement('ach_7day', gameState.log.total_records >= 7);
        checkAchievement('ach_sleep', gameState.log.sleep_records >= 5);
        checkAchievement('ach_ironwill', gameState.log.workout_records >= 14);
        checkAchievement('ach_pr', gameState.log.pr_records >= 1);
        checkAchievement('ach_fatburner', gameState.log.hiit_records >= 5);
    }

    // --- UI æ›´æ–° (UI Update) ---
    // çµ±ä¸€çš„å°èˆªåˆ‡æ›é‚è¼¯
    function navigate(tabName, clickedElement) {
        // 1. Update Tab Content Visibility
        let tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
            tabcontent[i].classList.remove("active");
        }
        document.getElementById(tabName).style.display = "block";
        document.getElementById(tabName).classList.add("active");

        // 2. Update Top Tab Buttons Active State
        let tablinks = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        
        if (clickedElement && clickedElement.classList.contains('tab-button')) {
            clickedElement.classList.add("active");
        } else {
             const targetTopButton = Array.from(tablinks).find(btn => btn.getAttribute('onclick').includes(`'${tabName}'`));
             if (targetTopButton) targetTopButton.classList.add("active");
        }


        // 3. Update Bottom Nav Active State
        document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        const navMap = {
            'training': 'è¨“ç·´å ´',
            'avatar': 'è¡£æ«¥',
            'achievements': 'æˆå°±',
            'tavern': 'é…’é¤¨'
        };
        const targetNavText = navMap[tabName];
        if (targetNavText) {
             if (clickedElement && clickedElement.classList.contains('nav-item')) {
                clickedElement.classList.add('active');
             } else {
                 const targetNavItem = Array.from(document.querySelectorAll('.bottom-nav .nav-item')).find(item => item.textContent.includes(targetNavText));
                 if (targetNavItem) targetNavItem.classList.add('active');
             }
        }
    }
    
    // å…¼å®¹èˆŠçš„ openTab å‡½å¼
    function openTab(evt, tabName) {
        navigate(tabName, evt.currentTarget);
    }


    function updateUI() {
        document.getElementById('level-val').textContent = gameState.level;
        document.getElementById('path-val').textContent = gameState.path === 'muscle' ? 'ğŸ’ª å¢è‚Œ' : (gameState.path === 'fatloss' ? 'ğŸ”¥ æ¸›è„‚' : '-');
        document.getElementById('muscle-val').textContent = gameState.inbody.muscle !== null ? gameState.inbody.muscle.toFixed(1) : '-';
        document.getElementById('fat-val').textContent = gameState.inbody.fat !== null ? gameState.inbody.fat.toFixed(1) : '-';
        document.getElementById('str-level-val').textContent = gameState.str.level;
        document.getElementById('end-level-val').textContent = gameState.end.level;
        
        // æ›´æ–°é‡‘å¹£
        document.getElementById('gold-val').textContent = gameState.gold.toLocaleString();

        // STR XP Bar
        const strXpNeeded = xpForLevel(gameState.str.level);
        const strPercentage = (gameState.str.xp / strXpNeeded) * 100;
        const strBar = document.getElementById('str-xp-bar');
        strBar.style.width = `${strPercentage}%`;
        strBar.textContent = `${gameState.str.xp}/${strXpNeeded}`;
        
        // END XP Bar
        const endXpNeeded = xpForLevel(gameState.end.level);
        const endPercentage = (gameState.end.xp / endXpNeeded) * 100;
        const endBar = document.getElementById('end-xp-bar');
        endBar.style.width = `${endPercentage}%`;
        endBar.textContent = `${gameState.end.xp}/${endXpNeeded}`;

        // InBody & Character æ•¸æ“šå›å¡«
        if (gameState.inbody.muscle !== null) document.getElementById('inbody-muscle').value = gameState.inbody.muscle;
        if (gameState.inbody.fat !== null) document.getElementById('inbody-fat').value = gameState.inbody.fat;
        if (gameState.inbody.visceral !== null) document.getElementById('inbody-visceral').value = gameState.inbody.visceral;
        if (gameState.inbody.weight !== null) document.getElementById('inbody-weight').value = gameState.inbody.weight;
        document.getElementById('char-gender').value = gameState.gender;
        document.getElementById('char-height').value = gameState.height;
    }
    
    // æ ¹æ“šé«”æ…‹ã€æ€§åˆ¥å’Œèº«é«˜æ”¹è®Šé ­åƒ (CD3: è³¦äºˆå‰µé€ åŠ›èˆ‡å›é¥‹)
    function updateAvatar() {
        const avatar = document.getElementById('avatar-image');
        const panel = document.querySelector('.character-panel');
        const muscle = gameState.inbody.muscle;
        const fat = gameState.inbody.fat;
        const height = gameState.height || 170; // é è¨­ 170

        let emoji = 'ğŸ›¡ï¸';
        let color = 'var(--text-light)';
        let title = 'æ•¸æ“šå¾…æ›´æ–°';
        let borderColor = 'var(--border-color)';

        if (fat !== null && muscle !== null && gameState.inbody.weight !== null) {
            const BMI_proxy = gameState.inbody.weight / Math.pow(height / 100, 2);
            
            if (gameState.gender === 'male') {
                if (fat < 15 && muscle > 35) { // é ‚ç´šé«”æ…‹
                    emoji = 'ğŸ’ª'; // åŠ›é‡ä¹‹ç‹
                    color = '#ffc107';
                    title = 'å¥ç¾å¤§å¸«ï¼';
                    borderColor = '#ffc107';
                } else if (fat < 20 && muscle > 30) { // ç²¾å¯¦æˆ°å£«
                    emoji = 'âš”ï¸'; 
                    color = '#38c738';
                    title = 'ç²¾å¯¦æˆ°å£«';
                    borderColor = '#38c738';
                } else if (BMI_proxy > 27) {
                    emoji = 'ğŸ»'; // é«”å‹è¼ƒå¤§
                    color = '#ffcc80';
                    title = 'åŠ›é‡å„²å‚™ä¸­...';
                    borderColor = '#ffcc80';
                } else {
                    emoji = 'ğŸƒ';
                }
            } else { // female
                if (fat < 22 && muscle > 25) { // é ‚ç´šé«”æ…‹
                    emoji = 'ğŸ’ƒ'; // å¥ç¾èˆè€…
                    color = '#e94560';
                    title = 'å¥ç¾å¤§å¸«ï¼';
                    borderColor = '#e94560';
                } else if (fat < 25 && muscle > 20) { // ç²¾å¯¦æˆ°å£«
                    emoji = 'ğŸ¹'; 
                    color = '#03a9f4';
                    title = 'ç²¾å¯¦å¼“ç®­æ‰‹';
                    borderColor = '#03a9f4';
                } else if (BMI_proxy > 27) {
                    emoji = 'ğŸ'; // é«”å‹è¼ƒå¤§
                    color = '#ff8f00';
                    title = 'è€åŠ›å„²å‚™ä¸­...';
                    borderColor = '#ff8f00';
                } else {
                    emoji = 'ğŸ§˜';
                }
            }
        }
        
        // è§’è‰²å¤–è§€éš¨èº«é«˜è®ŠåŒ– (ä¾‹å¦‚ï¼šé ­åƒå°ºå¯¸)
        // æ ¹æ“šèº«é«˜åœ¨ 150cm (0.8) åˆ° 200cm (1.2) ä¹‹é–“èª¿æ•´å°ºå¯¸å› å­
        const sizeFactor = 1 + ((height - 170) / 100) * 0.5; // 170cm -> 1, 220cm -> 1.25, 120cm -> 0.75
        avatar.style.fontSize = `${2 * Math.max(0.7, Math.min(1.3, sizeFactor))}em`; // é™åˆ¶å°ºå¯¸åœ¨åˆç†ç¯„åœ

        // æ ¹æ“šè£å‚™æ”¹è®Šé ­åƒ
        if (gameState.inventory.includes('hat')) {
             emoji = 'ğŸ‘‘'; // è£å‚™å¸½å­
        }
        
        avatar.textContent = emoji;
        avatar.style.color = color;
        avatar.title = title;
        panel.style.borderColor = borderColor; // æ ¹æ“šé«”æ…‹æ”¹è®Šé‚Šæ¡†é¡è‰²
    }

    // å‹•æ…‹ç”Ÿæˆæ´»å‹•å¡ç‰‡
    function populateActivities() {
        const muscleContainer = document.getElementById('muscle-activities');
        const fatlossContainer = document.getElementById('fatloss-activities');
        muscleContainer.innerHTML = ''; 
        fatlossContainer.innerHTML = ''; 
        for (const id in activities) {
            const act = activities[id];
            const card = document.createElement('div');
            card.className = 'activity-card';
            card.onclick = () => logActivity(id);
            card.innerHTML = `<h4>${act.name}</h4><div class="xp-reward"><span class="xp-str">+${act.str} STR</span> / <span class="xp-end">+${act.end} END</span></div>`;
            if (id.startsWith('m')) {
                muscleContainer.appendChild(card);
            } else {
                fatlossContainer.appendChild(card);
            }
        }
    }

    // æ›´æ–°æˆå°± UI
    function updateAchievementsUI() {
        const container = document.getElementById('achievement-list');
        container.innerHTML = '';
        const sortedAchievements = Object.entries(gameState.achievements).sort(([, a], [, b]) => b.unlocked - a.unlocked); // å·²è§£é–çš„æ’åœ¨å‰é¢

        for (const [id, ach] of sortedAchievements) {
            const staticAch = achievements[id];
            const card = document.createElement('div');
            card.className = `achievement-card ${ach.unlocked ? 'unlocked' : ''}`;
            card.innerHTML = `<div class="ach-icon">${staticAch.icon}</div><div class="ach-details"><h4>${staticAch.name}</h4><p>${staticAch.desc}</p></div>`;
            container.appendChild(card);
        }
    }
    
    // æ•´åˆæ‰€æœ‰ UI æ›´æ–°
    function updateAllUI() {
        updateUI();
        updateAvatar();
        updateAchievementsUI();
    }
    
    // --- å„²å­˜èˆ‡è®€å–é‚è¼¯ (Firestore/Local Storage) ---
    function getDocRef() {
        if (!currentUser) return null;
        if (currentUser.isGuest) {
            // éŠå®¢æ¨¡å¼ä½¿ç”¨ Local Storageï¼Œä¸éœ€è¦ Firestore å¼•ç”¨
            return null;
        }
        return db.collection('users').doc(currentUser.uid);
    }

    async function loadGameFromFirestore() {
        const docRef = getDocRef();
        if (!docRef) return; 

        try {
            const doc = await docRef.get();
            if (doc.exists) {
                // å¾é›²ç«¯è¼‰å…¥æ•¸æ“š
                gameState = doc.data().state;
                // ç¢ºä¿éœæ…‹æˆå°±æ•¸æ“šæ›´æ–°ï¼Œé˜²æ­¢èˆŠè³‡æ–™éºæ¼æ–°çš„ name/desc/icon
                for (const id in achievements) {
                     if (gameState.achievements[id]) {
                          gameState.achievements[id].name = achievements[id].name;
                          gameState.achievements[id].desc = achievements[id].desc;
                          gameState.achievements[id].icon = achievements[id].icon;
                     } else {
                          gameState.achievements[id] = { ...achievements[id], unlocked: false };
                     }
                }
                showToast("é›²ç«¯é€²åº¦è¼‰å…¥å®Œæˆï¼", 'success');
            } else {
                // ç¬¬ä¸€æ¬¡ç™»å…¥ï¼Œåˆå§‹åŒ–ä¸¦å­˜æª”
                resetGameState();
                showToast("æ–°å†’éšªå®¶ï¼Œé–‹å§‹ä½ çš„æ—…ç¨‹å§ï¼", 'info');
                // é¡¯ç¤ºè·¯ç·šé¸æ“‡ä»‹é¢
                document.getElementById('path-selection-overlay').style.display = 'flex';
                await saveGame();
            }
        } catch (error) {
            console.error("è¼‰å…¥ Firestore å¤±æ•—:", error);
            showToast("è¼‰å…¥é›²ç«¯é€²åº¦å¤±æ•—ï¼", 'error');
        } finally {
            updateAllUI();
        }
    }
    
    function loadGameFromLocalStorage() {
        const stateJSON = localStorage.getItem(GUEST_STATE_KEY);
        if (stateJSON) {
            gameState = JSON.parse(stateJSON);
            // ç¢ºä¿éœæ…‹æˆå°±æ•¸æ“šæ›´æ–°
            for (const id in achievements) {
                 if (gameState.achievements[id]) {
                      gameState.achievements[id].name = achievements[id].name;
                      gameState.achievements[id].desc = achievements[id].desc;
                      gameState.achievements[id].icon = achievements[id].icon;
                 } else {
                      gameState.achievements[id] = { ...achievements[id], unlocked: false };
                 }
            }
            showToast("æœ¬åœ°é€²åº¦è¼‰å…¥å®Œæˆï¼", 'success');
        } else {
            resetGameState();
            showToast("æ–°éŠå®¢ï¼Œè«‹é¸æ“‡ä½ çš„å†’éšªè·¯ç·šï¼", 'info');
            document.getElementById('path-selection-overlay').style.display = 'flex';
        }
        updateAllUI();
    }


    async function saveGame() {
        if (!currentUser) return;

        if (currentUser.isGuest) {
            // éŠå®¢æ¨¡å¼å„²å­˜åˆ° Local Storage
            localStorage.setItem(GUEST_STATE_KEY, JSON.stringify(gameState));
            // showToast("é€²åº¦å·²å„²å­˜è‡³æœ¬æ©Ÿã€‚", 'info', 1500);
            return;
        }

        const docRef = getDocRef();
        if (!docRef) return; 

        try {
            // å„²å­˜åˆ° Firestore
            await docRef.set({
                uid: currentUser.uid,
                email: currentUser.email,
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                state: gameState
            }, { merge: true }); // ä½¿ç”¨ merge ä»¥å…è¦†è“‹å…¶ä»–ç”¨æˆ¶æ•¸æ“š
            // showToast("é›²ç«¯é€²åº¦å·²å„²å­˜ã€‚", 'info', 1500);
        } catch (error) {
            console.error("å„²å­˜ Firestore å¤±æ•—:", error);
            showToast("é›²ç«¯å„²å­˜å¤±æ•—ï¼", 'error');
        }
    }


    // å½ˆå‡ºå¼é€šçŸ¥
    function showToast(message, type = 'default', duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        // è‡ªå‹•ç§»é™¤
        setTimeout(() => {
            toast.style.opacity = 0;
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                container.removeChild(toast);
            }, 500);
        }, duration);
    }
    
    // --- æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• ---
    window.onload = () => {
        populateActivities();
        // Firebase Auth listener æœƒåœ¨é€™é‚Šæ¥ç®¡è¼‰å…¥é‚è¼¯
    };
    </script>
</body>
</html>